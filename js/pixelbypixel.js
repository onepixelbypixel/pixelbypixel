class pixelbypixel{constructor(t={}){this.drawto=t.to||document.getElementById("canvas"),this.drawfrom=t.from||document.getElementById("defaultImage"),this.hFI(),this.scale=t.scale&&t.scale>0&&t.scale<=50?.01*t.scale:.08,this.palette=t.palette||[[0,0,0],[255,255,255],[255,218,69],[73,231,236],],this.maxHeight=t.maxHeight,this.maxWidth=t.maxWidth,this.ctx=this.drawto.getContext("2d")}hFI(){return this.drawfrom.style.visibility="hidden",this.drawfrom.style.position="fixed",this.drawfrom.style.top=0,this.drawfrom.style.left=0,this}sFIS(t){return this.drawfrom.src=t,this}sP(t){return this.palette=t,this}sS(t){return this.scale=t>0&&t<=50?.01*t:.08,this}cS(t,a){let e=0;for(let h=0;h<3;h++){let i=t[h]-a[h];e+=i*i}return Math.sqrt(e)}sC(t){let a=this.palette[0],e=this.cS(t,a);for(let h=1;h<this.palette.length;h++){let i=this.palette[h],d=this.cS(t,i);if(d<e&&(a=i,e=d),0===d)break}return a}p(){this.drawto.width=this.drawfrom.naturalWidth,this.drawto.height=this.drawfrom.naturalHeight;let t=this.drawto.width*this.scale,a=this.drawto.height*this.scale,e=document.createElement("canvas");e.width=this.drawto.width,e.height=this.drawto.height,e.style.visibility="hidden",e.style.position="fixed",e.style.top="0",e.style.left="0",(this.drawto.width>900||this.drawto.height>900)&&(this.scale*=.5,t=this.drawto.width*this.scale,a=this.drawto.height*this.scale,e.width=Math.max(t,a)+50,e.height=Math.max(t,a)+50);let h=e.getContext("2d");h.drawImage(this.drawfrom,0,0,t,a),document.body.appendChild(e),this.ctx.mozImageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1;let i=this.drawfrom.naturalWidth;this.drawfrom.naturalWidth>300&&(i+=this.drawfrom.naturalWidth>this.drawfrom.naturalHeight?parseInt(this.drawfrom.naturalWidth/(this.drawfrom.naturalWidth*this.scale))/1.5:parseInt(this.drawfrom.naturalWidth/(this.drawfrom.naturalWidth*this.scale)));let d=this.drawfrom.naturalHeight;return this.drawfrom.naturalHeight>300&&(d+=this.drawfrom.naturalHeight>this.drawfrom.naturalWidth?parseInt(this.drawfrom.naturalHeight/(this.drawfrom.naturalHeight*this.scale))/1.5:parseInt(this.drawfrom.naturalHeight/(this.drawfrom.naturalHeight*this.scale))),this.ctx.drawImage(e,0,0,t,a,0,0,i,d),e.remove(),this}cGS(){let t=this.drawto.width,a=this.drawto.height,e=this.ctx.getImageData(0,0,t,a);for(let h=0;h<e.height;h++)for(let i=0;i<e.width;i++){let d=4*h*e.width+4*i,r=(e.data[d]+e.data[d+1]+e.data[d+2])/3;e.data[d]=r,e.data[d+1]=r,e.data[d+2]=r}return this.ctx.putImageData(e,0,0,0,0,e.width,e.height),this}cGA(t,a){let e=document.createElement("img");e.src=a,e.onload=function(){let a=document.getElementById(t),h=a.getContext("2d"),{width:i,height:d}=e;a.width=i,a.height=d,h.drawImage(e,0,0,i,d),h.drawImage(e,0,0);let r=h.getImageData(0,0,a.width,a.height),l=px.aCED(r);h.clearRect(0,0,i,d);for(let s=0;s<d;s++)for(let o=0;o<i;o++){let $=(s*i+o)*1,w=l[$];255===w&&h.fillRect(o,s,1,1)}px.gWFE(h,l)}}aCED(t){let a=this.cTG(t),e=this.aGB(a),{gradientData:h,gradientAngles:i}=this.aSO(e),d=this.aNMS(h,i),r=this.aHT(d);return r}cTG(t){let a=new Uint8ClampedArray(t.data.length/4);for(let e=0,h=0;e<t.data.length;e+=4,h++){let i=t.data[e],d=t.data[e+1],r=t.data[e+2],l=Math.round((i+d+r)/3);a[h]=l}return a}aGB(t){let a=canvas.width,e=canvas.height,h=[[1,4,7,4,1],[4,16,26,16,4],[7,26,41,26,7],[4,16,26,16,4],[1,4,7,4,1]],i=new Uint8ClampedArray(t.length),d=Math.floor(2.5);for(let r=0;r<e;r++)for(let l=0;l<a;l++){let s=0;for(let o=0;o<5;o++)for(let $=0;$<5;$++){let w=l+($-d),n=r+(o-d);if(w>=0&&w<a&&n>=0&&n<e){let g=h[o][$],m=t[n*a+w];s+=m*g}}i[r*a+l]=Math.round(s/273)}return i}aSO(t){let a=canvas.width,e=canvas.height,h=new Uint8ClampedArray(t.length),i=new Uint8ClampedArray(t.length),d=[[-1,0,1],[-2,0,2],[-1,0,1]],r=[[-1,-2,-1],[0,0,0],[1,2,1]];for(let l=0;l<e;l++)for(let s=0;s<a;s++){let o=0,$=0;for(let w=0;w<3;w++)for(let n=0;n<3;n++){let g=s+(n-1),m=l+(w-1);if(g>=0&&g<a&&m>=0&&m<e){let _=d[w][n],f=r[w][n],c=t[m*a+g];o+=c*_,$+=c*f}}let u=Math.sqrt(o*o+$*$),x=Math.atan2($,o);h[l*a+s]=Math.round(u),i[l*a+s]=Math.round((x+Math.PI)*(255/(2*Math.PI)))}return{gradientData:h,gradientAngles:i}}aNMS(t,a){let e=canvas.width,h=canvas.height,i=new Uint8ClampedArray(t.length);for(let d=0;d<h;d++)for(let r=0;r<e;r++){let l=d*e+r,s=t[l],o=a[l];i[l]=s;let $=o>180?o-180:o,w,n;0<=$&&$<22.5||157.5<=$&&$<=180?(w=t[l-1],n=t[l+1]):22.5<=$&&$<67.5?(w=t[l-e-1],n=t[l+e+1]):67.5<=$&&$<112.5?(w=t[l-e],n=t[l+e]):112.5<=$&&$<157.5&&(w=t[l-e+1],n=t[l+e-1]),(s<w||s<n)&&(i[l]=0)}return i}aHT(t){let a=canvas.width,e=canvas.height,h=new Uint8ClampedArray(t.length);for(let i=0;i<e;i++)for(let d=0;d<a;d++){let r=i*a+d,l=t[r];l>=80&&255!==h[r]&&s(d,i)}function s(i,d){let r=[];for(r.push([i,d]);r.length>0;){let[l,s]=r.pop(),o=s*a+l,$=t[o];l>=0&&l<a&&s>=0&&s<e&&$>=30&&255!==h[o]&&(h[o]=255,r.push([l-1,s-1]),r.push([l,s-1]),r.push([l+1,s-1]),r.push([l-1,s]),r.push([l+1,s]),r.push([l-1,s+1]),r.push([l,s+1]),r.push([l+1,s+1]))}}return h}gWFE(t,a){let e=canvas.width,h=canvas.height;t.beginPath();for(let i=0;i<h;i++)for(let d=0;d<e;d++){let r=i*e+d,l=a[r];255===l&&(t.moveTo(d,i),t.lineTo(d+1,i))}t.stroke()}cLA(t=255){let a=this.drawto.width,e=this.drawto.height,h=this.ctx.getImageData(0,0,a,e);for(let i=0;i<h.data.length;i+=4){let d=h.data[i],r=h.data[i+1],l=h.data[i+2],s=.299*d+.587*r+.114*l;h.data[i]=s,h.data[i+1]=s,h.data[i+2]=s}let o=this.convolve(h,[-1,-1,-1,-1,8,-1,-1,-1,-1],3,1,0);for(let $=0;$<o.data.length;$+=4)o.data[$]=255-o.data[$],o.data[$+1]=255-o.data[$+1],o.data[$+2]=255-o.data[$+2];for(let w=0;w<o.data.length;w+=4){let n=o.data[w],g=o.data[w+1],m=o.data[w+2],_=(n+g+m)/3;_<t?(o.data[w]=0,o.data[w+1]=0,o.data[w+2]=0):(o.data[w]=255,o.data[w+1]=255,o.data[w+2]=255)}for(let f=0;f<h.data.length;f+=4){let c=h.data[f],u=o.data[f],x=Math.min(255,c+u);h.data[f]=x,h.data[f+1]=x,h.data[f+2]=x}return this.ctx.putImageData(h,0,0,0,0,h.width,h.height),this}convolve(t,a,e,h,i){let d=new ImageData(t.width,t.height),r=Math.floor(e/2);for(let l=0;l<t.height;l++)for(let s=0;s<t.width;s++){let o=0,$=0,w=0,n=0;for(let g=0;g<e;g++)for(let m=0;m<e;m++){let _=s+m-r,f=l+g-r;if(_>=0&&_<t.width&&f>=0&&f<t.height){let c=(f*t.width+_)*4,u=g*e+m;o+=a[u]*t.data[c],$+=a[u]*t.data[c+1],w+=a[u]*t.data[c+2],n+=a[u]*t.data[c+3]}}let x=(l*t.width+s)*4;d.data[x]=Math.min(255,Math.max(0,o/h+i)),d.data[x+1]=Math.min(255,Math.max(0,$/h+i)),d.data[x+2]=Math.min(255,Math.max(0,w/h+i)),d.data[x+3]=Math.min(255,Math.max(0,n/h+i))}return d}cP(){let t=this.drawto.width,a=this.drawto.height,e=this.ctx.getImageData(0,0,t,a);for(let h=0;h<e.height;h++)for(let i=0;i<e.width;i++){let d=4*h*e.width+4*i,r=this.sC([e.data[d],e.data[d+1],e.data[d+2],]);e.data[d]=r[0],e.data[d+1]=r[1],e.data[d+2]=r[2]}return this.ctx.putImageData(e,0,0,0,0,e.width,e.height),this}rI(){let t=document.createElement("canvas"),a=t.getContext("2d"),e=1;return this.maxWidth||this.maxHeight?(this.maxWidth&&this.drawto.width>this.maxWidth&&(e=this.maxWidth/this.drawto.width),this.maxHeight&&this.drawto.height>this.maxHeight&&(e=this.maxHeight/this.drawto.height),t.width=this.drawto.width,t.height=this.drawto.height,a.drawImage(this.drawto,0,0),this.drawto.width=this.drawto.width*e,this.drawto.height=this.drawto.height*e,this.ctx.drawImage(t,0,0,t.width,t.height,0,0,this.drawto.width,this.drawto.height),this):0}draw(){return this.drawto.width=this.drawfrom.width,this.drawto.height=this.drawfrom.height,this.ctx.drawImage(this.drawfrom,0,0),this.rI(),this}sI(){let t=document.createElement("a");t.download="image.png",t.href=this.drawto.toDataURL("image/png").replace("image/png","image/octet-stream"),document.querySelector("body").appendChild(t),t.click(),document.querySelector("body").removeChild(t)}fH(){let t=this.ctx.canvas.getContext("2d"),a=this.ctx.canvas,e=t.getImageData(0,0,a.width,a.height),h=e.data;for(let i=0;i<a.height;i++)for(let d=0;d<a.width/2;d++){let r=(i*a.width+d)*4,l=(i*a.width+(a.width-d-1))*4,s=h[r],o=h[r+1],$=h[r+2],w=h[r+3];h[r]=h[l],h[r+1]=h[l+1],h[r+2]=h[l+2],h[r+3]=h[l+3],h[l]=s,h[l+1]=o,h[l+2]=$,h[l+3]=w}t.putImageData(e,0,0)}iC(){let t=this.ctx.canvas.getContext("2d"),a=this.ctx.canvas,e=t.getImageData(0,0,a.width,a.height),h=new Set;for(let i=0;i<e.data.length;i+=4){let d=e.data[i],r=e.data[i+1],l=e.data[i+2],s=[d,r,l],o=s.join(",");h.add(o)}let $=Array.from(h).map(t=>t.split(",").map(t=>parseInt(t))),w=document.getElementById("detected-palettecolor");w.innerHTML="";for(let n=0;n<$.length;n++){let g=document.createElement("div");g.className="colorbox",g.style.backgroundColor=`rgb(${$[n][0]}, ${$[n][1]}, ${$[n][2]})`,g.style.width="20px",g.style.height="20px",w.appendChild(g)}}}